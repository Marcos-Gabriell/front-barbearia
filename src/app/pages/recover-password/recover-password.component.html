<div class="recovery-layout">
  <div class="recovery-card fade-in-up">
    
    <div class="card-header">
      <h2>Recuperação de Acesso</h2>
      <p *ngIf="step() === 1">Informe seu e-mail para buscar sua conta.</p>
      <p *ngIf="step() === 2">Digite o código de segurança enviado.</p>
      <p *ngIf="step() === 3">Crie uma nova senha segura.</p>
    </div>

    <div *ngIf="step() === 1" class="step-content">
      <form [formGroup]="emailForm" (ngSubmit)="submitEmail()">
        <div class="field">
          <label for="email">E-mail</label>
          <div class="input-wrapper">
            <input id="email" type="email" formControlName="email" placeholder="ex: gerente@barbearia.com"
              [class.error]="emailForm.get('email')?.touched && emailForm.get('email')?.invalid" />
            <div class="icon-slot">
              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></svg>
            </div>
          </div>
          <span class="error-msg" *ngIf="emailForm.get('email')?.touched && emailForm.get('email')?.invalid">
            E-mail inválido.
          </span>
        </div>

        <button class="btn-primary" type="submit" [disabled]="isLoading()">
          <span *ngIf="isLoading()" class="spinner"></span>
          {{ isLoading() ? 'Enviando...' : 'Receber código' }}
        </button>
      </form>
    </div>

    <div *ngIf="step() === 2" class="step-content">
      <div class="instruction-text">
        <p>Enviamos para: <b>{{ savedEmail() }}</b></p>
      </div>

      <form [formGroup]="codeForm" (ngSubmit)="submitCode()">
        <div class="field code-field">
          <label>Código de 6 dígitos</label>
          <div class="input-wrapper">
            <input 
              type="tel" 
              formControlName="code" 
              placeholder="000000" 
              maxlength="6" 
              class="input-code"
              (input)="onCodeInput($event)"
            >
          </div>
          <span class="error-msg" *ngIf="codeForm.get('code')?.touched && codeForm.get('code')?.invalid">
            Digite os 6 números.
          </span>
        </div>

        <button class="btn-primary" type="submit" [disabled]="isLoading()">
          <span *ngIf="isLoading()" class="spinner"></span>
          {{ isLoading() ? 'Verificando...' : 'Confirmar Código' }}
        </button>

        <div class="footer-link">
          <a href="javascript:void(0)" (click)="step.set(1)">Corrigir e-mail</a>
        </div>
      </form>
    </div>

    <div *ngIf="step() === 3" class="step-content">
      <form [formGroup]="passwordForm" (ngSubmit)="submitPassword()">
        
        <div class="field">
          <label>Nova Senha</label>
          <div class="input-wrapper">
            <input 
              [type]="showPassword() ? 'text' : 'password'" 
              formControlName="newPassword" 
              placeholder="Ex: Senha123"
              [class.error]="passwordForm.get('newPassword')?.touched && passwordForm.get('newPassword')?.invalid"
              (input)="updatePasswordStrength($event)"
            >
            <button type="button" class="eye-btn" (click)="togglePasswordVisibility()">
              <svg *ngIf="!showPassword()" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#64748b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"/><line x1="2" y1="2" x2="22" y2="22"/></svg>
              <svg *ngIf="showPassword()" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>
            </button>
          </div>

          <div class="strength-container" *ngIf="(passwordForm.get('newPassword')?.value ?? '').length > 0">
            <div class="bars">
              <div class="bar" [class.active]="passwordStrength() >= 1" [class]="strengthColor()"></div>
              <div class="bar" [class.active]="passwordStrength() >= 2" [class]="strengthColor()"></div>
              <div class="bar" [class.active]="passwordStrength() >= 3" [class]="strengthColor()"></div>
            </div>
            <span class="strength-label" [class]="strengthColor()">{{ strengthLabel() }}</span>
          </div>

          <ul class="requirements-list">
            <li [class.valid]="(passwordForm.get('newPassword')?.value ?? '').length >= 6">
              <span class="dot"></span> Mínimo 6 caracteres
            </li>
            <li [class.valid]="(passwordForm.get('newPassword')?.value ?? '').match('\\d')">
              <span class="dot"></span> Pelo menos um número
            </li>
          </ul>
        </div>

        <div class="field">
          <label>Confirmar Senha</label>
          <div class="input-wrapper">
            <input 
              [type]="showPassword() ? 'text' : 'password'" 
              formControlName="confirmNewPassword" 
              placeholder="******"
              [class.error]="passwordForm.get('confirmNewPassword')?.touched && passwordForm.get('confirmNewPassword')?.invalid"
            >
          </div>
        </div>

        <button class="btn-primary" type="submit" [disabled]="isLoading()">
          <span *ngIf="isLoading()" class="spinner"></span>
          {{ isLoading() ? 'Salvando...' : 'Alterar Senha' }}
        </button>
      </form>
    </div>

    <div class="footer-link" *ngIf="step() !== 2">
      <a routerLink="/login">
        Voltar para Login
      </a>
    </div>

  </div>
</div>