<div class="page-container fade-in">
  
  <header class="page-header">
    <div class="header-title">
      <h1>Catálogo de Serviços</h1>
      <p>Gerencie os preços e detalhes dos serviços oferecidos.</p>
    </div>
    <button class="btn-primary rounded-pill" (click)="openForm()">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
      <span class="btn-text">Novo Serviço</span>
    </button>
  </header>

  <div *ngIf="isPageLoading" class="empty-state">
    <div class="spinner" style="border-color: #10b981; border-top-color: transparent; margin: 0 auto 10px;"></div>
    <p>Carregando catálogo...</p>
  </div>

  <div class="services-grid" *ngIf="!isPageLoading">
    
    <div class="card service-card" *ngFor="let item of visibleServices; trackBy: trackById">
      <div class="card-content">
        <div class="card-top">
          <h3 [title]="item.name">{{ item.name }}</h3>
          <span class="badge status" [class.active]="item.active" [class.inactive]="!item.active">
            {{ item.active ? 'Ativo' : 'Inativo' }}
          </span>
        </div>

        <div class="price">{{ item.price | currency:'BRL' }}</div>
        
        <p class="description">{{ item.description || 'Sem descrição.' }}</p>
        
        <div class="meta-row">
          <span class="time-badge">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
            {{ item.durationMinutes }} min
          </span>

          <div class="actions-group">
            <button class="icon-btn" (click)="confirmToggleStatus(item)" [title]="item.active ? 'Desativar' : 'Ativar'">
               <svg *ngIf="item.active" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
               <svg *ngIf="!item.active" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 9.9-1"></path></svg>
            </button>
            <button class="icon-btn" (click)="openDetailsModal(item)" title="Ver Detalhes">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
            </button>
            <button class="icon-btn edit" (click)="openForm(item)" title="Editar">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
            </button>
            <button class="icon-btn delete" (click)="confirmDelete(item)" title="Excluir">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div *ngIf="!isPageLoading && services.length === 0" class="empty-state">
    <p>Nenhum serviço cadastrado.</p>
  </div>

  <div class="pagination-area" *ngIf="!isPageLoading && services.length > itemsPerPage">
    <button class="page-btn" (click)="prevPage()" [disabled]="currentPage === 1">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
    </button>
    <span class="page-info">Página {{ currentPage }} de {{ totalPages }}</span>
    <button class="page-btn" (click)="nextPage()" [disabled]="currentPage === totalPages">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
    </button>
  </div>
</div>

<div class="modal-overlay" *ngIf="showFormModal">
  <div class="modal-card fade-in-up">
    <div class="modal-header">
      <h2>{{ currentItem?.id ? 'Editar Serviço' : 'Novo Serviço' }}</h2>
      <button class="close-btn-circle" (click)="closeModals()" title="Fechar">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
      </button>
    </div>

    <form (ngSubmit)="save()" #form="ngForm">
      <div class="modal-body">
        
        <div class="alert-error-box fade-in" *ngIf="errorMessage">
          <div class="icon-wrapper">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
          </div>
          <div class="error-content">
            <strong>Atenção</strong>
            <span>{{ errorMessage }}</span>
          </div>
        </div>

        <div class="form-group">
          <label>Nome do Serviço</label>
          <input type="text" 
                 class="modern-input" 
                 [class.error-border]="submitted && (!formData.name || formData.name.length < 3)"
                 [(ngModel)]="formData.name" 
                 name="name" 
                 required 
                 minlength="3"
                 maxlength="100" 
                 placeholder="Ex: Corte Degradê" 
                 autofocus>
          <div class="hint text-right">{{formData.name?.length || 0}}/100</div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 160px; gap: 16px;">
          
          <div class="form-group">
            <label>Preço</label>
            <input type="tel" 
                   class="modern-input" 
                   [class.error-border]="submitted && (formData.price === null || formData.price === undefined)"
                   [value]="formattedPrice"
                   (input)="onPriceInput($event)"
                   name="priceFormatted" 
                   required>
          </div>

          <div class="form-group">
            <label>Duração</label>
            <div class="custom-number-input" style="width: 100%;" [class.error-border]="submitted && (!formData.durationMinutes || formData.durationMinutes < 5)">
              
              <button type="button" class="btn-step" (click)="decrementDuration()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line></svg>
              </button>
              
              <input type="number" 
                     class="input-no-spinner" 
                     [(ngModel)]="formData.durationMinutes" 
                     name="duration" 
                     readonly
                     required 
                     min="5" 
                     step="5">
              
              <span class="unit">min</span>
              
              <button type="button" class="btn-step" (click)="incrementDuration()">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
              </button>
            </div>
          </div>

        </div>

        <div class="form-group">
          <label>Responsáveis</label>
          <div class="responsibles-selector" [class.error-border]="submitted && formData.responsibleUserIds.length === 0">
            <button type="button" class="btn-select-users" (click)="openUserSelectModal()" [disabled]="isLoading">
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>
              Selecionar Responsáveis
            </button>
            
            <div class="selected-list-preview" *ngIf="formData.responsibleUserIds.length > 0">
              <span class="pill" *ngFor="let id of formData.responsibleUserIds">
                {{ getUserName(id) }}
              </span>
            </div>
            
            <div class="hint spaced-top error-msg fade-in" 
                 *ngIf="submitted && formData.responsibleUserIds.length === 0">
               <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>
               Selecione pelo menos 1 responsável.
            </div>
          </div>
        </div>

        <div class="form-group">
          <label>Descrição</label>
          <textarea class="modern-textarea no-resize" [(ngModel)]="formData.description" name="description" maxlength="100" placeholder="Detalhes opcionais..."></textarea>
          <div class="hint text-right">{{formData.description?.length || 0}}/100</div>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn-ghost" (click)="closeModals()">Cancelar</button>
        <button type="submit" class="btn-primary rounded-pill" [disabled]="isLoading">
          <div *ngIf="isLoading" class="spinner"></div>
          <span *ngIf="!isLoading">Salvar</span>
        </button>
      </div>
    </form>
  </div>
</div>

<div class="modal-overlay" *ngIf="showDetailsModal && currentItem">
  <div class="modal-card fade-in-up" style="max-width: 480px;">
    <div class="modal-header">
      <h2>Detalhes do Serviço</h2>
      <button class="close-btn-circle" (click)="closeModals()">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
      </button>
    </div>
    <div class="modal-body">
      <div class="details-content">
        <div class="details-top">
          <h3>{{ currentItem.name }}</h3>
          <span class="badge status" [class.active]="currentItem.active" [class.inactive]="!currentItem.active">
            {{ currentItem.active ? 'Ativo' : 'Inativo' }}
          </span>
        </div>
        <div class="details-grid">
          <div class="detail-box">
            <span class="label">Preço</span>
            <span class="value price">{{ currentItem.price | currency:'BRL' }}</span>
          </div>
          <div class="detail-box">
            <span class="label">Duração</span>
            <span class="value">{{ currentItem.durationMinutes }} min</span>
          </div>
        </div>
        <div class="detail-section">
          <span class="label">Descrição</span>
          <p class="text-block">{{ currentItem.description || 'Nenhuma descrição informada.' }}</p>
        </div>
        <div class="detail-section">
          <span class="label">Responsáveis ({{ currentItem.responsibleUsers?.length || 0 }})</span>
          <div class="users-grid">
            <ng-container *ngIf="currentItem.responsibleUsers?.length; else noUsers">
              <div class="user-chip" *ngFor="let u of currentItem.responsibleUsers">
                <div class="avatar-mini">{{ u.name.charAt(0) }}</div>
                <span>{{ u.name }}</span>
              </div>
            </ng-container>
            <ng-template #noUsers>
              <span class="text-muted" style="font-size: 13px;">Nenhum responsável vinculado.</span>
            </ng-template>
          </div>
        </div>
        <div class="detail-meta">
          <small>Cadastrado por: <b>{{ currentItem.createdByUserName || 'Sistema' }}</b></small>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-primary rounded-pill full-width" (click)="closeModals()">Fechar</button>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="showUserSelectModal">
  <div class="modal-card fade-in-up" style="max-height: 80vh;">
    <div class="modal-header">
      <h2>Selecionar Responsáveis</h2>
      <button class="close-btn-circle" (click)="closeUserSelectModal()">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
      </button>
    </div>
    <div class="modal-body">
      <div *ngIf="usersLoading" class="text-center" style="padding: 20px;">
        <div class="spinner" style="border-color: #10b981; border-top-color: transparent; margin: 0 auto;"></div>
        <p style="margin-top: 10px; color: #64748b;">Carregando usuários...</p>
      </div>
      <div class="user-selection-list" *ngIf="!usersLoading">
        <div class="checkbox-item" *ngFor="let u of paginatedUsers">
          <label class="custom-checkbox">
            <input type="checkbox" [checked]="isTempUserSelected(u.id)" (change)="toggleTempUserSelection(u.id)">
            <span class="checkmark"></span>
            <span class="user-info-row">
              <span class="user-name">{{ u.name }}</span>
              <span class="user-id">#{{ u.id }}</span>
            </span>
          </label>
        </div>
        <div class="empty-state" style="padding: 20px;" *ngIf="users.length === 0">
          Nenhum usuário disponível.
        </div>
      </div>
    </div>
    <div class="modal-footer space-between">
      <div class="pagination-mini" *ngIf="userTotalPages > 1">
        <button class="icon-btn-mini" (click)="prevUserPage()" [disabled]="userPage === 1">‹</button>
        <span>{{ userPage }} / {{ userTotalPages }}</span>
        <button class="icon-btn-mini" (click)="nextUserPage()" [disabled]="userPage === userTotalPages">›</button>
      </div>
      <div *ngIf="userTotalPages <= 1"></div>
      <div class="actions">
        <button class="btn-ghost" (click)="closeUserSelectModal()">Cancelar</button>
        <button class="btn-primary rounded-pill" (click)="confirmUserSelection()">Confirmar ({{ tempSelectedUserIds.length }})</button>
      </div>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="showDeleteModal">
  <div class="modal-card small-modal fade-in-up">
    <div class="modal-body text-center">
      <div class="warning-icon"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg></div>
      <h3>Excluir?</h3>
      <p>Confirmar exclusão de <b>{{ currentItem?.name }}</b>?</p>
      <div class="action-buttons-center">
        <button class="btn-ghost" (click)="closeModals()">Não</button>
        <button class="btn-danger rounded-pill" (click)="executeDelete()" [disabled]="isLoading"><div *ngIf="isLoading" class="spinner"></div><span *ngIf="!isLoading">Sim</span></button>
      </div>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="showToggleModal">
  <div class="modal-card small-modal fade-in-up">
    <div class="modal-body text-center">
      <div class="warning-icon yellow"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg></div>
      <h3>{{ currentItem?.active ? 'Desativar' : 'Ativar' }} Serviço?</h3>
      <p>Deseja alterar o status de <b>{{ currentItem?.name }}</b>?</p>
      <div class="action-buttons-center">
        <button class="btn-ghost" (click)="closeModals()">Cancelar</button>
        <button class="btn-primary rounded-pill" (click)="executeToggle()" [disabled]="isLoading"><div *ngIf="isLoading" class="spinner"></div><span *ngIf="!isLoading">Confirmar</span></button>
      </div>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="showSuccessModal">
  <div class="modal-card small-modal fade-in-up">
    <div class="modal-body text-center" style="padding-top: 30px; padding-bottom: 30px;">
      <div class="success-checkmark-anim"><div class="check-icon"><span class="icon-line line-tip"></span><span class="icon-line line-long"></span><div class="icon-circle"></div><div class="icon-fix"></div></div></div>
      <h3 class="success-title" style="margin-top: 16px;">Sucesso!</h3>
      <p class="success-message" style="font-size: 14px; margin-top: 8px;">{{ successMessage }}</p>
      <div class="action-buttons-center" style="margin-top: 24px;"><button class="btn-primary rounded-pill full-width" (click)="closeModals()">OK, Entendi</button></div>
    </div>
  </div>
</div>