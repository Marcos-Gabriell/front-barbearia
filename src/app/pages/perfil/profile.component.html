<div class="page-container fade-in">

  <header class="page-header">
    <div class="header-title">
      <h1>Meu Perfil</h1>
      <p>Gerencie suas informa√ß√µes pessoais e credenciais de acesso.</p>
    </div>
  </header>

  <div *ngIf="isLoading()" class="loading-state">
    <div class="spinner"></div>
    <p>Carregando...</p>
  </div>

  <div *ngIf="!isLoading()" class="card profile-main-card animate-up">

    <div class="profile-summary">
      <div class="avatar-circle-xl">{{ user()?.name?.charAt(0) }}</div>
      <div class="summary-text">
        <h2 class="text-truncate-header" [title]="user()?.name">{{ user()?.name }}</h2>
        <span class="badge role" [ngClass]="user()?.role?.toLowerCase()">{{ user()?.role }}</span>
      </div>
    </div>

    <div class="divider"></div>

    <div class="fields-list">

      <div class="field-row">
        <div class="field-icon-wrapper blue">
          <lucide-icon [name]="icons.UserIcon" class="w-5 h-5"></lucide-icon>
        </div>
        <div class="field-info">
          <span class="label">Nome Completo</span>
          <span class="value name-value" [title]="user()?.name">{{ user()?.name }}</span>
        </div>
        <button class="btn-icon-edit" (click)="openModal('NAME')" title="Editar Nome">
          <lucide-icon [name]="icons.Edit2" class="w-4 h-4"></lucide-icon>
        </button>
      </div>

      <div class="field-row">
        <div class="field-icon-wrapper purple">
          <lucide-icon [name]="icons.Mail" class="w-5 h-5"></lucide-icon>
        </div>
        <div class="field-info">
          <span class="label">E-mail</span>
          <span class="value email-value" [title]="user()?.email">
            {{ user()?.email }}
          </span>
          <span *ngIf="user()?.pendingEmail" class="pending-badge email-value" [title]="user()?.pendingEmail">
            <lucide-icon [name]="icons.Clock" class="w-3 h-3"></lucide-icon>
            Pendente: {{ user()?.pendingEmail }}
          </span>
        </div>
        <button class="btn-icon-edit" (click)="openModal('EMAIL')" title="Alterar E-mail">
          <lucide-icon [name]="icons.Edit2" class="w-4 h-4"></lucide-icon>
        </button>
      </div>

      <div class="field-row">
        <div class="field-icon-wrapper green">
          <lucide-icon [name]="icons.Phone" class="w-5 h-5"></lucide-icon>
        </div>
        <div class="field-info">
          <span class="label">Telefone</span>
          <span class="value">{{ formatPhoneDisplay(user()?.phone) }}</span>
        </div>
        <button class="btn-icon-edit" (click)="openModal('PHONE')" title="Editar Telefone">
          <lucide-icon [name]="icons.Edit2" class="w-4 h-4"></lucide-icon>
        </button>
      </div>

      <div class="field-row">
        <div class="field-icon-wrapper orange">
          <lucide-icon [name]="icons.Lock" class="w-5 h-5"></lucide-icon>
        </div>
        <div class="field-info">
          <span class="label">Senha</span>
          <span class="value password-mask">‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>
        </div>
        <button class="btn-icon-edit" (click)="openModal('PASSWORD')" title="Alterar Senha">
          <lucide-icon [name]="icons.Edit2" class="w-4 h-4"></lucide-icon>
        </button>
      </div>

      <!-- ‚úÖ DISPONIBILIDADE -->
      <div class="field-row">
        <div class="field-icon-wrapper teal">
          <lucide-icon [name]="icons.CalendarDays" class="w-5 h-5"></lucide-icon>
        </div>
        <div class="field-info">
          <span class="label">Disponibilidade</span>
          <span class="value">Defina seus hor√°rios e pausas</span>
        </div>
        <button class="btn-icon-edit" (click)="openModal('SCHEDULE')" title="Configurar Disponibilidade">
          <lucide-icon [name]="icons.Edit2" class="w-4 h-4"></lucide-icon>
        </button>
      </div>

    </div>
  </div>

  <!-- =======================
       MODAIS EXISTENTES (NAME, EMAIL, PHONE, PASSWORD)
  ======================== -->

  <!-- MODAL NAME -->
  <div class="modal-overlay" *ngIf="activeModal() === 'NAME'">
    <div class="modal-card fade-in-up">
      <div class="modal-header">
        <h2>Editar Nome</h2>
        <button class="close-btn-circle" (click)="closeModal()">
          <lucide-icon [name]="icons.X"></lucide-icon>
        </button>
      </div>
      <form [formGroup]="nameForm" (ngSubmit)="updateName()">
        <div class="modal-body">
          <div class="form-group">
            <label>Nome Completo</label>
            <input type="text" formControlName="name" class="modern-input" placeholder="Seu nome">
            <div *ngIf="nameForm.get('name')?.invalid && nameForm.get('name')?.touched" class="error-msg">
              M√≠nimo de 3 caracteres.
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-ghost" (click)="closeModal()">Cancelar</button>
          <button type="submit" class="btn-primary rounded-pill" [disabled]="isSaving()">
            <div *ngIf="isSaving()" class="spinner-small"></div>
            <span *ngIf="!isSaving()">Salvar</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- MODAL EMAIL -->
  <div class="modal-overlay" *ngIf="activeModal() === 'EMAIL'">
    <div class="modal-card fade-in-up">
      <div class="modal-header">
        <h2>Alterar E-mail</h2>
        <button class="close-btn-circle" (click)="closeModal()">
          <lucide-icon [name]="icons.X"></lucide-icon>
        </button>
      </div>
      <div class="modal-body">
        <form [formGroup]="emailForm" *ngIf="!showEmailCodeInput()" (ngSubmit)="initiateEmailUpdate()">
          <div class="form-group">
            <label>Novo E-mail</label>
            <input type="email" formControlName="email" class="modern-input" placeholder="exemplo@email.com">
          </div>
          <div class="modal-footer no-padding">
            <button type="button" class="btn-ghost" (click)="closeModal()">Cancelar</button>
            <button type="submit" class="btn-primary rounded-pill" [disabled]="isSaving()">
              <div *ngIf="isSaving()" class="spinner-small"></div>
              <span *ngIf="!isSaving()">Continuar</span>
            </button>
          </div>
        </form>

        <div *ngIf="showEmailCodeInput()">
          <p class="text-sm text-gray-500 mb-4 text-center">Digite o c√≥digo de 6 n√∫meros enviado.</p>
          <div class="form-group code-input-container">
            <input type="text" class="modern-input code-input" [value]="verificationCode()"
                   (input)="onCodeInput($event)" maxlength="6" inputmode="numeric" placeholder="0 0 0 0 0 0">
          </div>
          <div class="modal-footer no-padding">
            <button type="button" class="btn-ghost" (click)="closeModal()">Cancelar</button>
            <button type="button" class="btn-primary rounded-pill" (click)="confirmEmailUpdate()" [disabled]="isSaving()">
              <div *ngIf="isSaving()" class="spinner-small"></div>
              <span *ngIf="!isSaving()">Confirmar</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL PHONE -->
  <div class="modal-overlay" *ngIf="activeModal() === 'PHONE'">
    <div class="modal-card fade-in-up">
      <div class="modal-header">
        <h2>Editar Telefone</h2>
        <button class="close-btn-circle" (click)="closeModal()">
          <lucide-icon [name]="icons.X"></lucide-icon>
        </button>
      </div>
      <form [formGroup]="phoneForm" (ngSubmit)="updatePhone()">
        <div class="modal-body">
          <div class="form-group">
            <label>Celular / WhatsApp</label>
            <input type="tel"
                   formControlName="phone"
                   class="modern-input"
                   placeholder="(00) 00000-0000"
                   (input)="onPhoneInput($event)"
                   maxlength="15">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-ghost" (click)="closeModal()">Cancelar</button>
          <button type="submit" class="btn-primary rounded-pill" [disabled]="isSaving()">
            <div *ngIf="isSaving()" class="spinner-small"></div>
            <span *ngIf="!isSaving()">Salvar</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- MODAL PASSWORD -->
  <div class="modal-overlay" *ngIf="activeModal() === 'PASSWORD'">
    <div class="modal-card fade-in-up">
      <div class="modal-header">
        <h2>Alterar Senha</h2>
        <button class="close-btn-circle" (click)="closeModal()">
          <lucide-icon [name]="icons.X"></lucide-icon>
        </button>
      </div>
      <form [formGroup]="passwordForm" (ngSubmit)="updatePassword()">
        <div class="modal-body">
          <div class="form-group">
            <label>Senha Atual</label>
            <div class="password-input-wrapper">
              <input [type]="showCurrentPassword() ? 'text' : 'password'" formControlName="currentPassword" class="modern-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
              <button type="button" class="eye-btn" (click)="togglePasswordVisibility('current')">
                <span *ngIf="!showCurrentPassword()">üëÅÔ∏è</span>
                <span *ngIf="showCurrentPassword()">üôà</span>
              </button>
            </div>
            <div *ngIf="passwordForm.get('currentPassword')?.invalid && passwordForm.get('currentPassword')?.touched" class="error-msg">
              Obrigat√≥rio.
            </div>
          </div>

          <div class="form-group">
            <label>Nova Senha</label>
            <div class="password-input-wrapper">
              <input [type]="showNewPassword() ? 'text' : 'password'" formControlName="newPassword" class="modern-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
              <button type="button" class="eye-btn" (click)="togglePasswordVisibility('new')">
                <span *ngIf="!showNewPassword()">üëÅÔ∏è</span>
                <span *ngIf="showNewPassword()">üôà</span>
              </button>
            </div>
            <div *ngIf="passwordForm.get('newPassword')?.invalid && passwordForm.get('newPassword')?.touched" class="error-msg">
              M√≠nimo de 6 caracteres.
            </div>
          </div>

          <div class="form-group">
            <label>Confirmar Nova Senha</label>
            <div class="password-input-wrapper">
              <input [type]="showConfirmPassword() ? 'text' : 'password'" formControlName="confirmNewPassword" class="modern-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
              <button type="button" class="eye-btn" (click)="togglePasswordVisibility('confirm')">
                <span *ngIf="!showConfirmPassword()">üëÅÔ∏è</span>
                <span *ngIf="showConfirmPassword()">üôà</span>
              </button>
            </div>
            <div *ngIf="passwordForm.errors?.['mismatch'] && passwordForm.get('confirmNewPassword')?.touched" class="error-msg">
              As senhas n√£o conferem.
            </div>
          </div>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn-ghost" (click)="closeModal()">Cancelar</button>
          <button type="submit" class="btn-primary rounded-pill" [disabled]="isSaving()">
            <div *ngIf="isSaving()" class="spinner-small"></div>
            <span *ngIf="!isSaving()">Alterar Senha</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- =======================
       ‚úÖ MODAL AGENDA COM FILTROS E ANIMA√á√ïES
  ======================== -->
  <div class="modal-overlay modal-schedule-overlay" *ngIf="activeModal() === 'SCHEDULE'">
    <div class="modal-card modal-schedule scale-in">

      <div class="modal-header">
        <div class="modal-title-stack">
          <h2>Configurar Disponibilidade</h2>
          <p>Defina seus hor√°rios de trabalho e pausas.</p>
        </div>

        <button class="close-btn-circle" (click)="closeScheduleModal()">
          <lucide-icon [name]="icons.X"></lucide-icon>
        </button>
      </div>

      <!-- LOADING -->
      <div class="modal-body schedule-body" *ngIf="isScheduleLoading()">
        <div class="schedule-loading pulse-in">
          <div class="spinner"></div>
          <p>Carregando sua disponibilidade...</p>
        </div>
      </div>

      <!-- CONTENT -->
      <div class="modal-body schedule-body" *ngIf="!isScheduleLoading()">

        <!-- ‚úÖ FILTROS -->
        <div class="filter-tabs slide-down">
          <button 
            class="filter-btn" 
            [class.active]="scheduleFilter() === 'all'"
            (click)="scheduleFilter.set('all')">
            Todos
          </button>
          <button 
            class="filter-btn" 
            [class.active]="scheduleFilter() === 'active'"
            (click)="scheduleFilter.set('active')">
            Ativos
          </button>
          <button 
            class="filter-btn" 
            [class.active]="scheduleFilter() === 'inactive'"
            (click)="scheduleFilter.set('inactive')">
            Inativos
          </button>
        </div>

        <div class="schedule-head">
          <div class="hcol">Dia</div>
          <div class="hcol center">In√≠cio</div>
          <div class="hcol center">Fim</div>
          <div class="hcol center">Ativo</div>
          <div class="hcol right">A√ß√µes</div>
        </div>

        <div class="schedule-list">

          <div class="day-card stagger-in" 
               *ngFor="let day of scheduleDaysFiltered(); let i = index"
               [class.expanded]="expandedDay() === day.dayOfWeek"
               [class.inactive]="!day.active"
               [style.animation-delay.ms]="i * 40">

            <div class="day-row">
              <button class="day-toggle"
                      (click)="toggleExpand(day)"
                      [disabled]="!day.active"
                      [attr.aria-disabled]="!day.active"
                      [title]="day.active ? 'Abrir/Fechar pausas' : 'Dia inativo'">
                <span class="day-name">{{ dayLabel[day.dayOfWeek] }}</span>
                <lucide-icon [name]="icons.ChevronDown" class="chev"
                             [class.rotated]="expandedDay() === day.dayOfWeek"></lucide-icon>
              </button>

              <div class="col center">
                <input type="time"
                       class="modern-input time-input"
                       [disabled]="!day.active"
                       [(ngModel)]="day.startTime"
                       name="start_{{day.dayOfWeek}}">
              </div>

              <div class="col center">
                <input type="time"
                       class="modern-input time-input"
                       [disabled]="!day.active"
                       [(ngModel)]="day.endTime"
                       name="end_{{day.dayOfWeek}}">
              </div>

              <div class="col center">
                <label class="toggle-switch">
                  <input type="checkbox" [checked]="day.active" (change)="onToggleActive(day, $any($event.target).checked)">
                  <span class="slider round"></span>
                </label>
              </div>

              <div class="col right">
                <button class="btn-icon-add"
                        (click)="addBreak(day)"
                        [disabled]="!day.active || (day.breaks?.length || 0) >= 3"
                        [title]="(day.breaks?.length || 0) >= 3 ? 'M√°ximo de 3 pausas' : 'Adicionar pausa'">
                  <lucide-icon [name]="icons.Plus"></lucide-icon>
                </button>
              </div>
            </div>

            <!-- ‚úÖ EXPAND com anima√ß√£o -->
            <div class="breaks-panel expand-collapse" 
                 *ngIf="expandedDay() === day.dayOfWeek"
                 [@expandCollapse]>
              <div class="breaks-header">
                <strong>Pausas / Almo√ßo</strong>
              </div>

              <div class="breaks-list" *ngIf="(day.breaks?.length || 0) > 0; else emptyBreaks">
                <div class="break-row fade-in-up" 
                     *ngFor="let br of day.breaks; let idx = index"
                     [style.animation-delay.ms]="idx * 60">
                  <input type="time" class="modern-input time-input" [(ngModel)]="br.start" name="bstart_{{day.dayOfWeek}}_{{idx}}">
                  <span class="sep">at√©</span>
                  <input type="time" class="modern-input time-input" [(ngModel)]="br.end" name="bend_{{day.dayOfWeek}}_{{idx}}">

                  <button class="btn-icon-trash" (click)="removeBreak(day, idx)" title="Remover pausa">
                    <lucide-icon [name]="icons.Trash2"></lucide-icon>
                  </button>
                </div>
              </div>

              <ng-template #emptyBreaks>
                <div class="empty-breaks fade-in">
                  Nenhuma pausa cadastrada.
                </div>
              </ng-template>
            </div>

          </div>

        </div>
      </div>

      <div class="modal-footer schedule-footer" *ngIf="!isScheduleLoading()">
        <button type="button" class="btn-ghost" (click)="closeScheduleModal()">Cancelar</button>

        <button type="button" class="btn-primary rounded-pill" (click)="saveSchedule()" [disabled]="isScheduleSaving()">
          <div *ngIf="isScheduleSaving()" class="spinner-small"></div>
          <span *ngIf="!isScheduleSaving()">Salvar Agenda</span>
        </button>
      </div>

    </div>
  </div>

  <!-- ‚úÖ MODAL DE SUCESSO -->
  <div class="modal-overlay" *ngIf="showSuccessModal()">
    <div class="modal-card fade-in-up" style="max-width: 340px;">
      <div class="modal-body text-center" style="padding: 30px 24px; text-align: center;">

        <div class="success-checkmark-anim">
          <div class="check-icon">
            <span class="icon-line line-tip"></span>
            <span class="icon-line line-long"></span>
            <div class="icon-circle"></div>
            <div class="icon-fix"></div>
          </div>
        </div>

        <h3 style="margin: 20px 0 8px 0; color: var(--text-main); font-size: 20px; font-weight: 700;">
          {{ successTitle() }}
        </h3>

        <p style="color: var(--text-muted); font-size: 14px; margin: 0 0 24px 0; line-height: 1.5;">
          {{ successMessage() }}
        </p>

        <div class="action-buttons-center" style="display: flex; justify-content: center;">
          <button class="btn-primary rounded-pill" style="width: 100%; justify-content: center;" (click)="closeSuccessModal()">
            OK, Entendi
          </button>
        </div>

      </div>
    </div>
  </div>

</div>